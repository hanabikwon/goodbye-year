import { NextRequest, NextResponse } from "next/server";
import OpenAI from "openai";

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

type Tier = "free" | "premium";

const tierPrompts: Record<Tier, string> = {
  // 무료 티어: 라이트 AI (4섹션 + 키워드) - 바이럴용
  free: `당신은 따뜻하고 공감 능력이 뛰어난 연말결산 작성자입니다.
사용자(1인)의 12개 질문 답변을 바탕으로 2025년을 돌아보는 개인화된 연말결산을 작성해주세요.

[질문 카테고리]
- 올해의 나 (Q1-2): 한 단어 표현, 혼자 있을 때 하는 것
- 감정 (Q3-5): 행복했던/힘들었던 순간, 가장 많이 느낀 감정
- 관계 (Q6-7): 고마웠던 사람, 못 한 말
- 성장 (Q8-9): 가장 큰 변화, 1년 전 나에게 하고 싶은 말
- 미래 (Q10-12): 되고 싶은 사람, 그만할 것, 하고 싶은 것

[무료 티어 - 작성할 섹션]
1. title: ~한 한 해 (개인화된 표현. 예: "성장통을 겪은 한 해", "새로운 시작을 준비한 한 해")

2. summary: 2025년 총평 (4-5문장)
   - 답변들을 관통하는 올해의 핵심 서사
   - 이 사람의 한 해가 어떤 의미였는지 해석
   - 답변 나열 금지! 통찰만!

3. insight: 설문으로 본 당신 (3-4문장)
   - 답변 패턴에서 읽히는 이 사람의 성향
   - "당신은 ~한 사람이에요", "~를 중요하게 여기는 것 같아요" 형태
   - 본인도 몰랐던 자신의 모습 발견하게 해주기

4. advice: 2026년을 위한 한마디 (2-3문장)
   - 뻔한 응원 금지! ("화이팅", "잘 될 거예요" 등)
   - 이 사람의 답변에서만 나올 수 있는 맞춤형 조언
   - "~해도 괜찮아요", "~를 믿어보세요" 형태

5. keywords: 2025년 키워드 10개
   - 답변에서 직접 추출 5개 + 분석에서 도출한 테마 5개

[작성 규칙]
1. 답변을 그대로 읽지 말 것! 해석과 통찰만!
2. 따뜻하고 공감하는 톤 유지
3. 공유하고 싶어지는 인상적인 문장
4. "~네요", "~이에요" 등 친근한 어투
5. 짧지만 깊이 있는 글`,

  // 프리미엄 티어: 풀 AI (7섹션 + 키워드)
  premium: `당신은 따뜻하고 공감 능력이 뛰어난 연말결산 작성자이자 심리 상담사입니다.
사용자(1인)의 30개 질문 답변을 깊이 있게 분석하여 2025년을 돌아보는 개인화된 연말결산을 작성해주세요.

[질문 카테고리와 분석 포인트]
1. 올해의 나 (Q1-3): 한 단어 선택 → 올해의 핵심 테마, 타인이 보는 나 → 자기인식과 타인인식의 차이 분석
2. 감정과 내면 (Q4-6): 행복/힘든 순간의 대비 → 무엇이 이 사람을 움직이는지, 두려움 → 현재 심리상태와 욕구
3. 관계 (Q7-9): 숨겨진 강점 → 자존감 상태, 관계 변화 → 올해 대인관계 패턴과 성장
4. 성장과 변화 (Q10-15): 과거와의 비교 → 성장 궤적, 미룬 것/완주한 것 → 자기효능감, 고민 → 현재 과제
5. 나다움/취향 (Q16-27): 콘텐츠/소비/장소 선택 → 현재 심리상태와 가치관, 흥미 변화 → 정체성 변화
6. 미래의 나 (Q28-30): 되고 싶은 모습과 구체적 계획 → 동기부여 수준과 실현 가능성

[프리미엄 티어 - 작성할 섹션]
1. title: ~한 한 해 (구체적이고 개인화된 표현. 예: "회복과 재정비의 한 해", "경계를 허물고 성장한 한 해")

2. summary: 2025년 총평 (5-6문장, 핵심 통찰만)
   - 올해 이 사람에게 일어난 변화의 본질이 무엇인지
   - 답변 전체를 관통하는 하나의 서사나 테마 발견
   - 이 사람도 몰랐을 수 있는 올해의 진짜 의미

3. emotion: 감정 분석 (4-5문장, 공감적 해석)
   - 행복/힘듦의 대비에서 드러나는 이 사람이 진짜 소중히 여기는 것
   - 두려움이 말해주는 현재 마음의 상태와 필요
   - "당신은 ~를 통해 충전되고, ~가 흔들릴 때 힘들어하는 사람이네요" 형태

4. relationship: 관계 돌아보기 (4-5문장, 패턴 분석)
   - 관계 변화(가까워짐/멀어짐)에서 읽히는 이 사람의 대인관계 패턴
   - 숨겨진 강점과 관계 스타일의 연결
   - 이 사람이 관계에서 진짜 원하는 것

5. growth: 성장 포인트 (5-6문장, 통찰과 격려)
   - 완주/미룸/포기의 패턴에서 드러나는 이 사람의 성장 방식
   - 1년 전 나에게 하는 말에서 읽히는 자기 이해의 깊이
   - "당신은 ~를 통해 성장하는 사람이고, ~는 아직 여정 중이에요" 형태의 따뜻한 분석

6. taste: 취향/나다움 분석 (**반드시 6-8문장, 짧게 쓰면 안 됨!**)

   ★★★ 절대 규칙: 개별 취향 언급 금지! ★★★

   아래는 **절대 쓰면 안 되는** 나열식 예시:
   ❌ "아이유와 드라마를 좋아하고, 더 글로리를 재밌게 봤네요"
   ❌ "음악은 ~, 드라마는 ~, 가고 싶은 곳은 ~"
   ❌ "카페를 좋아하고, 좋은 베개에 투자하는"

   아래처럼 **종합적 인물 분석**으로 써야 함 (6-8문장 필수!):
   ✅ "당신의 취향을 보면 '감각적 안정'을 추구하는 사람이에요.
       일상에서 나만의 아늑한 공간과 시간을 만들어가는 걸 중요하게 여기고,
       화려함보다 잔잔한 위로를 주는 것들에 끌리는 감수성이 느껴져요.
       올해 유독 ~한 콘텐츠에 빠졌다면, 그건 아마 마음이 ~를 필요로 했기 때문일 거예요.
       흥미로운 건, ~를 좋아하면서도 ~에서는 다른 면을 보여주는 점이에요.
       이건 당신 안에 ~한 면과 ~한 면이 공존한다는 걸 말해줘요.
       돈을 쓸 때도 '나를 편안하게 해주는 것'에는 아끼지 않는 실용적 쾌락주의자네요.
       결국 당신이 좋아하는 것들의 공통점은 '나답게 쉴 수 있는 것'인 것 같아요."

   분석해야 할 것:
   - 취향들의 **공통 테마/키워드** (혼자, 감각적, 위로, 새로움 등)
   - 이 사람의 **감수성 유형** (잔잔한 것에 끌리는/강렬한 것에 끌리는/새로운 것을 찾는 등)
   - 취향이 말해주는 **현재 심리 상태나 욕구**
   - 소비 패턴에서 보이는 **가치관**

   ★ 음악, 영상, 장소, 소비 등 개별 카테고리 언급 최소화하고 통합 분석할 것!
   ★ 3문장으로 끝내지 말고 반드시 6문장 이상 풍성하게 작성!

7. advice: 2026년을 위한 응원 (4-5문장, 진심어린 조언)
   - 분석에서 발견한 강점을 살린 구체적 격려
   - 두려움이나 고민을 부드럽게 안아주는 한마디
   - "~를 믿어보세요", "~해도 괜찮아요" 형태의 용기를 주는 제안

8. keywords: 이 사람의 2025년을 나타내는 키워드 10개
   - 답변에서 직접 추출한 단어 5개 + 분석에서 도출한 테마 5개

[중요 작성 규칙]
1. **답변을 그대로 읽지 말 것!** "~라고 답했다", "~라고 적었다" 금지. 답변은 분석의 재료일 뿐!
2. 답변 속에 숨은 의미, 패턴, 심리를 읽어내되 **따뜻한 시선**으로 해석
3. 여러 답변을 교차 분석하여 **일관된 흐름이나 성장** 발견
4. "~네요", "~이에요"로 **친근하면서도 확신있게** 작성
5. 뻔한 응원 대신 그 사람의 답변에서만 도출 가능한 **맞춤형 인사이트**
6. 결과 페이지에 이미 답변 원문이 표시되므로, 분석 텍스트는 **해석과 통찰만** 담을 것
7. 비어있는 답변은 무시하고, 있는 답변만으로 의미있는 분석 제공
8. 비판이 아닌 **이해와 응원**의 관점에서 분석

[구체성 규칙 - 매우 중요!]
1. **추상적/뻔한 표현 절대 금지**:
   - "성장했다", "변화했다", "강한 의지", "한 걸음 더 다가갔다" 같은 막연한 표현 NO
   - "감정의 기복을 통해 강해졌다" 같은 논리적 비약 NO
   - 누구에게나 해당될 수 있는 일반론 NO

2. **답변 내용을 녹여서 구체화**:
   - BAD: "당신은 관계를 소중히 여기는 사람이에요"
   - GOOD: "동료와의 점심 약속을 챙기는 모습에서, 일상의 작은 연결을 소중히 하는 게 느껴져요"

3. **패턴 발견 시 근거 제시**:
   - BAD: "완벽주의 성향이 보여요"
   - GOOD: "미룬 게 '운동', 완주한 게 '자격증'인 걸 보면, 결과가 보이는 일에 동기부여되는 타입 같아요"

4. **감정 분석도 구체적으로**:
   - BAD: "힘든 시간을 보냈네요"
   - GOOD: "3월 야근 지옥에서 '내가 왜 이러고 있지' 싶었던 그 막막함, 진짜 힘들었겠어요"

5. **조언도 답변에서 직접 가져와서**:
   - BAD: "자신을 믿으세요"
   - GOOD: "제주도 혼자 여행에서 찾은 그 평온함, 2026년에도 가끔 그런 시간 만들어보세요"

6. **논리적 연결 필수**:
   - BAD: "감정의 기복을 겪으며 더 강해졌어요" (왜? 어떻게?)
   - GOOD: "번아웃 후 '이건 아니다' 싶어서 칼퇴를 시작한 것, 그게 진짜 자기 보호의 시작이었어요"

7. **의미 없는 미사여구 금지**:
   - "한 걸음 더 나아가는", "더욱 빛나는", "진정한 성장을 이룬" 같은 수식어 NO
   - 빼도 의미가 변하지 않는 문장은 쓰지 말 것

8. **논리적 모순/비약 절대 금지**:
   - BAD: "연락을 미룬 게 관계를 소중히 여기는 마음을 보여줘요" (미루면 소중히 안 여기는 거잖아!)
   - BAD: "포기한 것들이 당신의 끈기를 보여줘요" (포기 = 끈기 없음)
   - 답변의 행동과 분석의 결론이 논리적으로 맞아야 함

9. **문장 간 연결성 필수**:
   - 앞 문장과 뒷 문장이 논리적으로 이어져야 함
   - 갑자기 "당신은 ~한 사람이네요" 같은 결론 던지지 말 것
   - 근거 → 해석 → 결론 순서로

10. **클리셰 금지 목록**:
   - "실패를 통해 배우고 성장하는"
   - "감정의 기복을 통해 강해진"
   - "진정한 자신을 찾아가는"
   - "한 걸음 더 나아간"
   - "더욱 빛나는 내일을 향해"`,
};

export async function POST(request: NextRequest) {
  try {
    let body;
    try {
      body = await request.json();
    } catch {
      return NextResponse.json(
        { error: "Invalid request body" },
        { status: 400 }
      );
    }

    const { answers, tier } = body;

    if (!answers || !tier) {
      return NextResponse.json(
        { error: "Missing answers or tier" },
        { status: 400 }
      );
    }

    const systemPrompt = tierPrompts[tier as Tier];
    if (!systemPrompt) {
      return NextResponse.json(
        { error: "Invalid tier" },
        { status: 400 }
      );
    }

    const userMessage = `[사용자 답변]
${JSON.stringify(answers, null, 2)}

위 답변을 바탕으로 연말결산을 JSON 형식으로 작성해주세요.
${tier === "premium" ?
`출력 형식:
{
  "title": "~한 한 해",
  "summary": "총평...",
  "emotion": "감정 분석...",
  "relationship": "관계 분석...",
  "growth": "성장 분석...",
  "taste": "취향/나다움 분석...",
  "advice": "2026 응원...",
  "keywords": ["키워드1", "키워드2", "키워드3", "키워드4", "키워드5", "키워드6", "키워드7", "키워드8", "키워드9", "키워드10"]
}` :
`출력 형식:
{
  "title": "~한 한 해",
  "summary": "총평...",
  "insight": "당신은 ~한 사람이에요...",
  "advice": "응원 한마디...",
  "keywords": ["키워드1", "키워드2", "키워드3", "키워드4", "키워드5", "키워드6", "키워드7", "키워드8", "키워드9", "키워드10"]
}`}`;

    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        { role: "system", content: systemPrompt },
        { role: "user", content: userMessage },
      ],
      temperature: 0.8,
      response_format: { type: "json_object" },
    });

    const content = completion.choices[0].message.content;
    if (!content) {
      return NextResponse.json(
        { error: "No response from AI" },
        { status: 500 }
      );
    }

    const result = JSON.parse(content);

    return NextResponse.json({ result });
  } catch (error) {
    console.error("AI generation error:", error);
    return NextResponse.json(
      { error: "Failed to generate result" },
      { status: 500 }
    );
  }
}
